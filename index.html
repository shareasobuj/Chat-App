<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Personal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0b141a; color: #e9edef; font-family: sans-serif; }
        .whatsapp-bg { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: rgba(11, 20, 26, 0.95); background-blend-mode: overlay; }
        .my-msg { background-color: #005c4b; border-radius: 10px 0 10px 10px; align-self: flex-end; }
        .friend-msg { background-color: #202c33; border-radius: 0 10px 10px 10px; align-self: flex-start; }
        #auth-page, #main-app, #chat-screen { display: none; }
        .user-card:hover { background-color: #2a3942; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="auth-page" class="flex-1 flex flex-col justify-center items-center p-6">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="w-20 mb-8">
        <input id="email" type="email" placeholder="Email" class="w-full max-w-sm p-3 rounded bg-[#2a3942] mb-3 outline-none">
        <input id="pass" type="password" placeholder="Password" class="w-full max-w-sm p-3 rounded bg-[#2a3942] mb-6 outline-none">
        <div class="flex gap-4">
            <button onclick="authAction('login')" class="bg-[#00a884] px-8 py-2 rounded-full font-bold">Login</button>
            <button onclick="authAction('signup')" class="border border-[#00a884] px-8 py-2 rounded-full font-bold">Sign Up</button>
        </div>
    </div>

    <div id="main-app" class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-[#202c33] p-4 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold text-white">WhatsApp</h1>
            <div class="flex gap-4 items-center">
                <i class="fa-solid fa-ellipsis-vertical cursor-pointer" onclick="toggleMenu('main-menu')"></i>
                <div id="main-menu" class="hidden absolute right-4 top-14 bg-[#233138] py-2 w-40 shadow-xl z-50">
                    <div class="px-4 py-2 hover:bg-[#182229] cursor-pointer" onclick="openProfileSettings()">Profile</div>
                    <div class="px-4 py-2 hover:bg-[#182229] cursor-pointer" onclick="auth.signOut()">Logout</div>
                </div>
            </div>
        </header>
        <div id="user-list" class="flex-1 overflow-y-auto p-2">
            <p class="text-gray-500 text-center mt-10">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <div id="chat-screen" class="absolute inset-0 bg-[#0b141a] flex flex-col z-40">
        <header class="bg-[#202c33] p-3 flex items-center gap-3 shadow-md">
            <i class="fa-solid fa-arrow-left cursor-pointer p-2" onclick="closeChat()"></i>
            <img id="chat-user-pic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-10 h-10 rounded-full object-cover">
            <h2 id="chat-user-name" class="font-bold">Username</h2>
        </header>
        <div id="message-box" class="flex-1 overflow-y-auto p-4 whatsapp-bg flex flex-col gap-2"></div>
        <footer class="bg-[#202c33] p-3 flex items-center gap-2">
            <input id="chat-input" type="text" placeholder="Type a message" class="flex-1 bg-[#2a3942] p-2 rounded-full px-4 outline-none">
            <button onclick="sendMessage()" class="bg-[#00a884] w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fa-solid fa-paper-plane text-white"></i>
            </button>
        </footer>
    </div>

    <input type="file" id="pic-picker" class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, setDoc, where, or, and } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üî• ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ API ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®
        const firebaseConfig = {
              apiKey: "AIzaSyCDl5ewD2Q-oxslT-lmlE2AiyUtgt0iX8A",
  authDomain: "chat-app-51f1a.firebaseapp.com",
  databaseURL: "https://chat-app-51f1a-default-rtdb.firebaseio.com",
  projectId: "chat-app-51f1a",
  storageBucket: "chat-app-51f1a.firebasestorage.app",
  messagingSenderId: "714987169605",
  appId: "1:714987169605:web:26bf3586f9da2b6d52402c",
  measurementId: "G-HXW1L660ZF"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let selectedUserId = null;
        let unsubscribeMessages = null;

        // ‡¶Ö‡¶• ‡¶≤‡¶ú‡¶ø‡¶ï
        window.authAction = (type) => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            if(type === 'login') signInWithEmailAndPassword(auth, email, pass);
            else createUserWithEmailAndPassword(auth, email, pass);
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('auth-page').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                loadUserList();
            } else {
                document.getElementById('auth-page').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        // ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        function loadUserList() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                snapshot.forEach(u => {
                    if (u.id !== auth.currentUser.uid) {
                        const data = u.data();
                        list.innerHTML += `
                            <div class="user-card flex items-center gap-4 p-4 border-b border-[#233138] cursor-pointer transition" onclick="openChat('${u.id}', '${data.name}', '${data.url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}')">
                                <img src="${data.url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="w-12 h-12 rounded-full object-cover">
                                <div><p class="font-bold">${data.name || 'User'}</p><p class="text-xs text-gray-500">Tap to chat</p></div>
                            </div>`;
                    }
                });
            });
        }

        // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßã‡¶≤‡¶æ
        window.openChat = (uid, name, pic) => {
            selectedUserId = uid;
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-user-name').innerText = name;
            document.getElementById('chat-user-pic').src = pic;
            listenMessages(uid);
        };

        window.closeChat = () => {
            document.getElementById('chat-screen').style.display = 'none';
            if(unsubscribeMessages) unsubscribeMessages();
        };

        // ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï (Private Chat Query)
        function listenMessages(friendId) {
            const myId = auth.currentUser.uid;
            // ‡¶è‡¶á ‡¶ï‡ßã‡ßü‡ßá‡¶∞‡¶ø‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶™‡¶®‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡ßÅ‡¶ú‡¶®‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá
            const q = query(
                collection(db, "messages"),
                orderBy("time", "asc")
            );

            if(unsubscribeMessages) unsubscribeMessages();
            
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const box = document.getElementById('message-box');
                box.innerHTML = "";
                snapshot.forEach(d => {
                    const data = d.data();
                    // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡ßÅ‡¶ú‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá?
                    if ((data.sender === myId && data.receiver === friendId) || (data.sender === friendId && data.receiver === myId)) {
                        const isMe = data.sender === myId;
                        box.innerHTML += `
                            <div class="${isMe ? 'my-msg' : 'friend-msg'} p-2 px-3 max-w-[80%] shadow-sm">
                                <p class="text-sm">${data.text}</p>
                            </div>`;
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text || !selectedUserId) return;
            
            await addDoc(collection(db, "messages"), {
                text,
                sender: auth.currentUser.uid,
                receiver: selectedUserId,
                time: Date.now()
            });
            input.value = "";
        };

        window.toggleMenu = (id) => document.getElementById(id).classList.toggle('hidden');

        window.openProfileSettings = () => {
            const name = prompt("Enter Name:");
            const picker = document.getElementById('pic-picker');
            picker.onchange = (e) => {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await setDoc(doc(db, "users", auth.currentUser.uid), { name, url: reader.result });
                    alert("Profile Updated!");
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            picker.click();
        };
    </script>
</body>
</html>
